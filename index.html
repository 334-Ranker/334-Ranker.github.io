<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="utf-8" />
    <title>334-Ranker</title>
    <style type="text/css">
        table.res {
            width: 100%;
            border-collapse: collapse;
            border-spacing: 0;
        }

        table.res th,
        table.res td {
            padding: 4px;
            border: solid 1px #af9d85;
        }

        table.res tr:nth-child(odd) {
            background-color: #eee
        }

        input[type=text] {
            padding: 6px;
            border-radius: 4px;
            border: none;
            box-shadow: 0 0 0 1px #ccc inset;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
        }

        input[type=text]:focus {
            outline: 0;
            box-shadow: 0 0 0 2px rgb(33, 150, 243) inset;
        }

        input[type=date] {
            padding: 6px;
            border-radius: 4px;
            border: none;
            box-shadow: 0 0 0 1px #ccc inset;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
        }

        input[type=date]:focus {
            outline: 0;
            box-shadow: 0 0 0 2px rgb(33, 150, 243) inset;
        }

        input[type=submit] {
            display: inline-block;
            width: 100%;
            padding: 6px;
            border: none;
            border-radius: 4px;
            background-color: #afafaf;
            color: #000;
            font-weight: bold;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            cursor: pointer;
            border: 2px solid transparent;
        }

        input[type=submit]:hover {
            background-color: #cfcfcf;
            border: 2px solid #7f7f7f;
        }

        input[type=submit]:focus {
            background-color: #cfcfcf;
            border: 2px solid #7f7f7f;
        }

        .loader {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            border: solid 4px;
            border-color: #000000 #00000010 #00000010;
            position: relative;
            animation-name: spin;
            animation-duration: 1s;
            animation-iteration-count: infinite;
            animation-timing-function: linear;
            margin: 0 auto;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .hidden {
            display: none;
        }
    </style>
</head>

<body>
    <h1>334-Ranker Records Explorer</h1>
    現在、2022/07/30以降のデータが入っています<br>
    検索オペレータは空白なら無指定になります。ただし結果は最大500件しか返しません<br>
    <table>
        <tr>
            <td>DATE-MIN</td>
            <td>DATE-MAX</td>
            <td>USERNAME</td>
            <td></td>
        </tr>
        <tr>
            <td> <input type="date" id="dateMin">
            </td>
            <td> <input type="date" id="dateMax">
            </td>
            <td>@ <input type="text" id="username">
            </td>
            <td> <input type="submit" id="submit" value="SEARCH">
            </td>
        </tr>
    </table>
    <div id="loader" class="loader hidden"></div>
    <div id="res"></div>
    <script type="text/javascript">
        const EncodeHTMLForm = (data) => {
            let params = [];
            for (let name in data) {
                let value = data[name];
                let param = encodeURIComponent(name) + '=' + encodeURIComponent(value);
                params.push(param);
            }
            return params.join('&').replace(/%20/g, '+');
        }
        const ajax = (url, data, success) => {
            let req = new XMLHttpRequest();
            req.onreadystatechange = function () {
                if (req.readyState == 4) {
                    success(JSON.parse(req.responseText));
                } else {

                }
            }
            req.open('GET', url + ((typeof data) == "string" ? data : "?" + EncodeHTMLForm(data)));
            req.send(null);
        }
        const conv = (record) => {
            return record >= 0 ? record : 2 * 60 * 1000 - record;
        };
        const getLink = (status) => {
            return `https://twitter.com/${status.username}/status/${status.statusid}`;
        };
        const loadData = () => {
            document.getElementById("loader").classList.remove("hidden");
            document.getElementById("res").innerHTML = "";
            ajax('https://api.334.nenone.net', "?" + location.hash.slice(2), (res) => {
                document.getElementById("loader").classList.add("hidden");
                res.sort((l, r) => { return conv(l.record) < conv(r.record) ? -1 : 1; });
                let i = 0;
                document.getElementById("res").innerHTML = `
                <table class="res"><tr><th>INDEX</th><th>DATE</th><th>NAME</th><th>USERNAME</th><th>RECORD</th><th>CLIENT</th><th>LINK</th></tr>
                ${res.map(e => {
                    let date = new Date(e.date);
                    return `<tr><td>${++i}</td><td>${date.toLocaleDateString()}</td>
                    <td>${`<a href="https://twitter.com/i/user/${e.userid}">${e.name}</a>`}</td>
                    <td>${`<a href="https://twitter.com/i/user/${e.userid}">${"@" + e.username}</a>`}</td>
                    <td>${(e.record / 1000).toFixed(3)}</td>
                    <td>${e.client}</td>
                    <td>${`<a href="${getLink(e)}">LINK</a>`}</td>
                    </tr>`;
                }).join('')}</table>`;
            });
        };
        document.getElementById("submit").onclick = () => {
            location.hash =
                "#/dateMin=" + document.getElementById("dateMin").value
                + "&dateMax=" + document.getElementById("dateMax").value
                + "&username=" + document.getElementById("username").value;
        };
        const setForm = () => {
            const qs = location.hash.slice(2).split("&");
            qs.map(e => e.split("=")).forEach(e => {
                if (e[0] == "dateMin") {
                    document.getElementById("dateMin").value = e[1];
                } else if (e[0] == "dateMax") {
                    document.getElementById("dateMax").value = e[1];
                } else if (e[0] == "username") {
                    document.getElementById("username").value = e[1];
                }
            });
        };
        const route = () => {
            setForm();
            if (location.hash.length > 1) {
                loadData();
            } else {
                document.getElementById("loader").classList.add("hidden");
                document.getElementById("res").innerHTML = "";
            }
        }
        window.onhashchange = route;
        route();
    </script>
</body>

</html>